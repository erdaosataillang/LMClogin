<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ログイン中</title>
  <!-- Open Sansフォント -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/versions/2.14.0/sdk.js"></script>
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background-color: #fff;
    }

    .mikepad-loading {
      width: 150px;
      position: absolute;
      top: 45%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    .mikepad-loading .binding {
      width: 27px;
      height: 4px;
      border: 2px solid #E15958;
      margin: 0 auto;
    }

    .mikepad-loading .pad {
      width: 15px;
      height: 18px;
      border: 2px solid #E15958;
      border-top: 0;
      padding: 6px;
      margin: 0 auto;
    }

    .mikepad-loading .line {
      width: 15px;
      margin-top: 4px;
      border-top: 2px solid #E15958;
      opacity: 0;
      animation: writeline 3s infinite ease-in;
    }

    .mikepad-loading .line:first-child {
      margin-top: 0;
    }

    .mikepad-loading .line.line1 { animation-delay: 0s; }
    .mikepad-loading .line.line2 { animation-delay: 0.5s; }
    .mikepad-loading .line.line3 { animation-delay: 1s; }

    .mikepad-loading .text {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      color: #E15958;
    }

    @keyframes writeline {
      0%   { width: 0px; opacity: 0; }
      33%  { width: 15px; opacity: 1; }
      70%  { opacity: 1; }
      100% { opacity: 0; }
    }

    #status-message {
      margin-top: 80px;
      text-align: center;
      color: #333;
      font-size: 14px;
      transition: opacity 0.3s ease;
    }
  </style>
</head>
<body>
  <div class="mikepad-loading">
    <div class="binding"></div>
    <div class="pad">
      <div class="line line1"></div>
      <div class="line line2"></div>
      <div class="line line3"></div>
    </div>
    <div class="text">LMC service is loading...</div>
  </div>

  <p id="status-message"></p>

  <script>
    const liffId = "2007060333-7KJQnW68";

    liff.init({ liffId: liffId })
      .then(() => {
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          getProfileAndRedirect();
        }
      })
      .catch((err) => {
        console.error("LIFFの初期化に失敗しました: ", err);
        redirectWithNull();
      });

    function getProfileAndRedirect() {
      liff.getProfile()
        .then(profile => {
          const userName = profile.displayName || "null";
          const lineID = profile.userId || "null";
          const iconURL = profile.pictureUrl || "null";

          const messages = [
            `${userName}さんの識別情報をサーバーに送信しています...`,
            "サーバーからの応答を待っています...",
            "処理が完了しました"
          ];

          let messageIndex = 0;
          const statusEl = document.getElementById("status-message");

          const interval = setInterval(() => {
            if (messageIndex < messages.length) {
              statusEl.textContent = messages[messageIndex];
              messageIndex++;
            } else {
              clearInterval(interval);
            }
          }, 600);

          const redirectUrl = 
            "https://script.google.com/macros/s/AKfycbyFTBDI2Dxz4_w75x8A7Ra2w8PVwVRoigAFJhZTQsilSAPYkb_QK_81zGFQulYWN6dYdg/exec" +
            "?lineID=" + encodeURIComponent(lineID) +
            "&userName=" + encodeURIComponent(userName) +
            "&iconURL=" + encodeURIComponent(iconURL);

          setTimeout(() => {
            window.location.href = redirectUrl;
          }, 2400); // 0.6s * 3 + buffer
        })
        .catch((err) => {
          console.error("プロフィール情報の取得に失敗しました: ", err);
          redirectWithNull();
        });
    }

    function redirectWithNull() {
      const redirectUrl = 
        "https://script.google.com/macros/s/AKfycbyFTBDI2Dxz4_w75x8A7Ra2w8PVwVRoigAFJhZTQsilSAPYkb_QK_81zGFQulYWN6dYdg/exec" +
        "?lineID=null&userName=null&iconURL=null";
      window.location.href = redirectUrl;
    }
  </script>
</body>
</html>


